# 報表格式修改報告

## 修改日期
2024-12-24

## 更新日期
2024-12-24 (第二次修改)

## 修改內容概述

本次修改主要針對代理管理平台的報表查詢功能進行了重大的表格格式優化，使其更符合專業博彩系統的規範和用戶需求。

## 主要修改項目

### 1. 下注記錄日期欄位優化
- **修改前**：有三個日期欄位：日期、開始日期、結束日期（重複且混亂）
- **修改後**：刪除單獨的"日期"欄位，只保留"開始日期"和"結束日期"
- **優化布局**：將原本的 col-md-2 改為 col-md-3，提供更寬敞的輸入空間

### 2. 報表查詢表格結構重新設計

#### 2.1 表頭結構優化
- **修改前**：單層表頭，所有欄位平鋪
- **修改後**：採用雙層表頭結構
  - 第一層：分組標題（會員輸贏、代理級別名稱）
  - 第二層：具體欄位

#### 2.2 欄位重新組織
新的欄位結構如下：

**基礎數據**
- 用戶名（支持點擊跳轉）
- 下注金額
- 有效金額

**會員輸贏組**
- 輸贏（反轉顯示，從代理視角看）
- 退水
- 盈虧結果

**代理數據組**（動態顯示當前代理級別）
- 佔成（目前為0%）
- 佔成金額（目前為0.00）
- 佔成結果（目前為0.00）
- 實佔退水（顯示實際退水百分比）
- 賺水（退水利潤）
- 盈虧結果（代理最終盈虧）
- 上交貨量（等於總下注金額）
- 上級交收（應收下線 + 盈虧結果）

### 3. 數據邏輯調整

#### 3.1 會員輸贏顯示邏輯
- **原邏輯**：直接顯示 memberWinLoss
- **新邏輯**：顯示 -memberWinLoss（反轉符號）
- **原因**：從代理視角看，會員贏錢代表代理輸錢

#### 3.2 上級交收計算
- **公式**：-item.profitLoss - item.rebateProfit
- **含義**：應收下線金額加上代理的盈虧結果

#### 3.3 賺水邏輯
- **顯示內容**：rebateProfit（退水利潤）
- **說明**：代理從退水中獲得的利潤

### 4. 視覺優化

#### 4.1 顏色方案
- 保持原有的盈虧顏色邏輯（紅色虧損、綠色盈利）
- 退水相關欄位使用 badge-warning（黃色）
- 佔成相關欄位使用 badge-info（藍色）

#### 4.2 表格樣式
- 添加 table-sm 類，使表格更緊湊
- 調整最小寬度設定，確保數據不會擠壓

### 5. 動態級別顯示
- 表頭會根據當前瀏覽的代理級別動態顯示
- 如果在麵包屑導航中，顯示當前級別
- 否則顯示登入用戶的級別

## 技術實現細節

### 前端文件修改
1. `agent/frontend/index.html`
   - 修改下注記錄篩選表單
   - 重構報表查詢表格結構

2. `deploy/frontend/index.html`
   - 同步所有修改到生產版本

### 關鍵代碼片段

```html
<!-- 雙層表頭結構 -->
<tr style="background-color: #2c3e50;">
    <th rowspan="2">用戶名</th>
    <th rowspan="2">下注金額</th>
    <th rowspan="2">有效金額</th>
    <th colspan="3">會員輸贏</th>
    <th colspan="7">{{ 動態級別名稱 }}</th>
</tr>
```

```javascript
// 上級交收計算
{{ formatProfit(-item.profitLoss - item.rebateProfit) }}
```

## 影響範圍
- 下注記錄查詢功能
- 報表查詢功能
- 相關的數據展示邏輯

## 後續建議
1. 實現真正的佔成功能，替換目前的佔位數據
2. 添加更多的統計指標
3. 考慮添加圖表視覺化功能
4. 優化移動端顯示效果

## 測試重點
1. 確認日期範圍查詢功能正常
2. 驗證所有數據計算邏輯正確
3. 測試點擊跳轉功能
4. 檢查不同級別代理的顯示效果

## 版本控制
- 已同步修改到主版本和deploy版本
- 建議進行完整的功能測試後再部署到生產環境

## 第二次修改內容 (2024-12-24)

### 報表表格結構調整

1. **新增"應收下線"欄位**
   - 位置：在"佔成"左邊
   - 計算邏輯：-item.profitLoss（會員盈虧的反轉）
   - 含義：代理應收下線的金額

2. **調整分組結構**
   - 代理組欄位從7個減少到6個（移除了"實佔退水"）
   - "上交貨量"和"上級交收"改為獨立欄位，不屬於任何分組
   - 使用 rowspan="2" 讓這兩個欄位跨越兩行

3. **欄位順序調整**
   新的欄位順序：
   - 用戶名
   - 下級金額
   - 有效金額
   - **會員輸贏組**：輸贏、退水、盈虧結果
   - **代理組**：應收下線、佔成、佔成金額、佔成結果、賺水、盈虧結果
   - **獨立欄位**：上交貨量、上級交收

### 修改的文件
- agent/frontend/index.html
- deploy/frontend/index.html
- 更新報表格式修改報告.md 