# 下注記錄期間查詢功能實現報告

## 功能概述

為代理管理平台的下注記錄查詢功能添加期間查詢支持，並實現當從報表查詢中點擊會員名進入下注記錄時，自動使用相同的期間範圍進行查詢。

## 實現內容

### 1. 前端功能增強

#### 1.1 數據結構擴展
- 在 `betFilters` 中新增 `startDate` 和 `endDate` 欄位
- 保持向後相容性，原有的 `date` 單日查詢功能仍然可用

#### 1.2 用戶介面優化
- **日期欄位重新排列**：將原本的3列布局改為5列布局
  - 日期：單日查詢
  - 開始日期：期間查詢起始日
  - 結束日期：期間查詢結束日
  - 期數：期數篩選
  - 快捷選項：期間快速選擇下拉選單

#### 1.3 快捷期間選項
新增下拉式選單提供以下快捷選項：
- **今天**：當日下注記錄
- **昨天**：前一日下注記錄
- **本週**：本週開始至今的記錄
- **本月**：本月開始至今的記錄
- **上月**：上個月完整期間的記錄
- **清除**：清空所有日期篩選條件

#### 1.4 函數功能擴展

##### `setBetDateRange(type)` 新增函數
```javascript
setBetDateRange(type) {
    const today = new Date();
    let startDate, endDate;
    
    switch(type) {
        case 'today':
            startDate = endDate = today.toISOString().split('T')[0];
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            startDate = endDate = yesterday.toISOString().split('T')[0];
            break;
        // ... 其他期間選項
    }
    
    this.betFilters.startDate = startDate;
    this.betFilters.endDate = endDate;
    this.betFilters.date = ''; // 清空單日查詢
}
```

##### `viewMemberBets(memberUsername, dateRange)` 函數增強
- 新增 `dateRange` 可選參數
- 支持從報表查詢傳遞期間資訊
- 自動設置對應的期間篩選條件

### 2. 後端API增強

#### 2.1 參數支持擴展
在 `/bets` API 中新增對以下參數的支持：
- `startDate`：期間查詢開始日期
- `endDate`：期間查詢結束日期

#### 2.2 查詢邏輯優化
```javascript
// 添加日期過濾邏輯
if (date) {
    // 單日查詢（優先級最高）
    whereClause += ` AND DATE(created_at) = $${paramIndex}`;
    params.push(date);
    paramIndex++;
} else if (startDate && endDate) {
    // 期間查詢
    whereClause += ` AND DATE(created_at) BETWEEN $${paramIndex} AND $${paramIndex + 1}`;
    params.push(startDate, endDate);
    paramIndex += 2;
} else if (startDate) {
    // 只有開始日期
    whereClause += ` AND DATE(created_at) >= $${paramIndex}`;
    params.push(startDate);
    paramIndex++;
} else if (endDate) {
    // 只有結束日期
    whereClause += ` AND DATE(created_at) <= $${paramIndex}`;
    params.push(endDate);
    paramIndex++;
}
```

### 3. 報表整合功能

#### 3.1 會員點擊增強
修改報表查詢中的會員點擊功能：
```html
<button @click="viewMemberBets(item.username, {startDate: reportFilters.startDate, endDate: reportFilters.endDate})">
    {{ item.username }}
    <i class="fas fa-list ms-1 small"></i>
</button>
```

#### 3.2 期間自動傳遞
- 當從報表查詢點擊會員名時，自動傳遞當前報表的期間範圍
- 在下注記錄頁面顯示對應的期間篩選
- 提供清晰的用戶提示訊息

## 技術實現細節

### 1. 文件修改清單

#### 前端文件 (主要版本)
- `agent/frontend/js/main.js`
  - 擴展 `betFilters` 數據結構
  - 修改 `resetBetFilters()` 函數
  - 更新 `searchBets()` 參數傳遞
  - 增強 `viewMemberBets()` 函數
  - 新增 `setBetDateRange()` 函數

- `agent/frontend/index.html`
  - 重新設計下注記錄篩選區域布局
  - 新增期間查詢欄位
  - 添加快捷期間選擇下拉選單
  - 修改報表中的會員點擊調用

#### 前端文件 (部署版本)
- `deploy/frontend/js/main.js` - 同主要版本修改
- `deploy/frontend/index.html` - 同主要版本修改

#### 後端文件
- `agentBackend.js`
  - 擴展 `/bets` API 參數支持
  - 增強日期篩選邏輯

- `deploy/agentBackend.js` - 同主要版本修改

### 2. 向後相容性

- 保持原有的單日查詢功能 (`date` 參數)
- 原有的 API 調用方式仍然有效
- 新增功能不影響現有業務流程

### 3. 用戶體驗優化

#### 3.1 智能篩選邏輯
- **單日查詢優先**：當 `date` 有值時，忽略期間查詢
- **期間查詢靈活**：支持只設開始日期或結束日期
- **快捷操作**：提供常用期間的一鍵設置

#### 3.2 視覺化提升
- 使用不同的欄位布局清晰區分不同查詢方式
- 下拉選單提供直觀的期間選擇
- 成功提示包含期間資訊

## 測試場景

### 1. 基本功能測試

#### 1.1 期間查詢測試
- [ ] 設置開始日期和結束日期，驗證查詢結果
- [ ] 只設置開始日期，驗證從該日期開始的所有記錄
- [ ] 只設置結束日期，驗證到該日期為止的所有記錄
- [ ] 同時設置單日查詢和期間查詢，驗證單日查詢優先

#### 1.2 快捷選項測試
- [ ] 測試「今天」選項，驗證結果為當日記錄
- [ ] 測試「昨天」選項，驗證結果為前一日記錄
- [ ] 測試「本週」選項，驗證結果為本週至今記錄
- [ ] 測試「本月」選項，驗證結果為本月至今記錄
- [ ] 測試「上月」選項，驗證結果為上月完整記錄
- [ ] 測試「清除」選項，驗證所有日期篩選被清空

### 2. 整合功能測試

#### 2.1 報表整合測試
- [ ] 在報表查詢中設置期間範圍
- [ ] 點擊有下注記錄的會員名
- [ ] 驗證自動跳轉到下注記錄頁面
- [ ] 驗證期間篩選自動設置為報表的期間
- [ ] 驗證查詢結果正確顯示該會員在該期間的下注記錄

#### 2.2 用戶體驗測試
- [ ] 驗證提示訊息包含期間資訊
- [ ] 驗證頁面切換流暢
- [ ] 驗證篩選條件正確保持

### 3. 邊界條件測試

#### 3.1 數據邊界測試
- [ ] 測試跨月期間查詢
- [ ] 測試跨年期間查詢
- [ ] 測試開始日期晚於結束日期的情況
- [ ] 測試未來日期的查詢

#### 3.2 相容性測試
- [ ] 驗證原有的單日查詢功能正常
- [ ] 驗證原有的會員篩選功能正常
- [ ] 驗證原有的期數篩選功能正常
- [ ] 驗證重置功能清空所有新增欄位

## 用戶操作指南

### 1. 期間查詢操作

#### 1.1 手動設置期間
1. 進入「下注記錄」頁面
2. 設置「開始日期」和「結束日期」
3. 點擊「搜索」按鈕
4. 查看指定期間內的下注記錄

#### 1.2 使用快捷選項
1. 進入「下注記錄」頁面
2. 點擊「期間」下拉選單
3. 選擇所需的期間選項（今天、本週、本月等）
4. 系統自動設置對應的日期範圍並執行查詢

#### 1.3 從報表查詢進入
1. 在「報表查詢」頁面設置期間範圍
2. 執行報表查詢
3. 點擊有下注記錄的會員用戶名（綠色按鈕）
4. 系統自動跳轉到下注記錄頁面並使用相同期間進行查詢

### 2. 功能組合使用

#### 2.1 期間 + 會員篩選
- 設置期間範圍後，再選擇特定會員
- 查看該會員在指定期間的下注記錄

#### 2.2 期間 + 期數篩選
- 設置期間範圍後，再輸入特定期數
- 查看指定期間內特定期數的下注記錄

## 預期效果

### 1. 功能完整性
- ✅ 支持靈活的期間查詢
- ✅ 提供便捷的快捷期間選項
- ✅ 實現報表與下注記錄的無縫整合
- ✅ 保持原有功能的完整性

### 2. 用戶體驗提升
- ✅ 減少手動輸入日期的操作
- ✅ 提供直觀的期間選擇方式
- ✅ 實現跨頁面的期間資訊傳遞
- ✅ 保持介面的一致性和直觀性

### 3. 系統穩定性
- ✅ 保持向後相容性
- ✅ 優化數據庫查詢效率
- ✅ 確保數據準確性
- ✅ 維持系統安全性

## 結論

本次下注記錄期間查詢功能的實現成功地：

1. **擴展了查詢能力**：從單日查詢擴展到靈活的期間查詢
2. **提升了用戶體驗**：提供快捷期間選項和跨頁面資訊傳遞
3. **保持了系統穩定**：維持向後相容性和原有功能完整性
4. **優化了業務流程**：實現報表查詢與下注記錄的有效整合

這個功能將大大提升代理管理平台的查詢效率和用戶體驗，特別是在需要查看特定期間業績和會員活動記錄的場景中。 