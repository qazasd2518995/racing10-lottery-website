# 極速賽車代理管理與退水系統

## 系統概述

本系統實現了完整的代理層級管理和退水分配機制，確保了金錢流轉的透明和準確性。

## 主要功能

### 1. 代理層級管理

#### 層級導航
- **面包屑導航**：清晰顯示當前管理的代理層級
- **進入下級**：點擊代理用戶名可進入該代理的下級管理
- **返回上級**：提供返回按鈕快速回到上級層級
- **層級限制**：每級代理只能創建比自己低一級的下級代理

#### 代理創建
- **基本資訊**：用戶名、密碼、代理級別
- **佣金設定**：可設定代理佣金比例（%）
- **退水模式**：
  - 全拿所有退水：該代理獲得所有可得退水
  - 設定具體比例：自定義退水比例
  - 全退給下級：不獲得退水，全部給下級

### 2. 退水系統

#### 退水計算
- **基礎退水率**：4.1%（從會員下注金額中扣除）
- **分配原則**：按代理層級和設定進行分配
- **計算公式**：總退水金額 = 下注金額 × 4.1%

#### 退水分配邏輯
```
會員下注 → 扣除賠率差額(4.1%) → 按代理鏈分配退水

分配順序：直屬代理 → 上級代理 → ... → 總代理
分配方式：
- 全拿模式：該代理拿走所有剩餘退水，分配結束
- 比例模式：按設定比例從總退水中分配
- 全退模式：該代理不拿退水，留給上級
```

### 3. 金錢流轉邏輯

#### 會員下注流程
1. **下注扣除**：從會員餘額扣除下注金額
2. **賠率計算**：使用包含退水的賠率（原賠率 × (1-4.1%)）
3. **退水分配**：按代理層級分配4.1%的退水
4. **派彩處理**：中獎時直接增加會員餘額

#### 資金安全保障
- **無中生有防護**：所有資金增減都有明確來源
- **無中損失防護**：退水總額不會超過可分配金額
- **餘額同步**：主系統與代理系統餘額實時同步
- **交易記錄**：所有資金流動都有完整記錄

## 技術實現

### 後端API

#### 主後端（backend.js）
- `distributeRebate(username, betAmount)`：退水分配主函數
- `getAgentChain(username)`：獲取會員代理鏈
- `allocateRebateToAgent()`：分配退水給具體代理

#### 代理後端（agentBackend.js）
- `GET /api/member-agent-chain`：獲取會員代理鏈
- `POST /api/allocate-rebate`：分配退水給代理
- `PUT /api/update-rebate-settings/:agentId`：更新退水設定

### 前端功能

#### 層級導航
- 面包屑導航顯示當前層級路徑
- 點擊代理名稱進入下級管理
- 返回按鈕快速回到上級

#### 退水設定
- 創建代理時設定退水模式
- 創建後可調整退水設定
- 實時顯示當前退水配置

## 數據庫結構

### 代理表（agents）
```sql
- rebate_percentage: 退水比例（小數）
- rebate_mode: 退水模式（'all'/'percentage'/'none'）
- max_rebate_percentage: 最大可設定退水比例
```

### 交易記錄（transactions）
```sql
- type: 'rebate' 表示退水交易
- description: 詳細說明退水來源
- balance_after: 交易後餘額
```

## 使用流程

### 代理管理員操作
1. 登入代理管理系統
2. 在代理管理頁面查看下級代理
3. 點擊「新增代理」創建下級代理
4. 設定退水模式和比例
5. 點擊代理名稱進入下級管理
6. 使用「退水設定」按鈕調整設定

### 會員下注流程
1. 會員在遊戲介面下注
2. 系統扣除下注金額
3. 開獎後自動結算輸贏
4. 同時分配退水給代理鏈
5. 代理可在交易記錄中查看退水收入

## 系統優勢

### 透明度
- 所有資金流動都有記錄
- 退水分配邏輯清晰可追蹤
- 代理層級關係一目了然

### 靈活性
- 多種退水模式適應不同需求
- 可隨時調整退水設定
- 支援無限層級代理結構

### 安全性
- 嚴格的金額驗證機制
- 防止資金異常增減
- 完整的錯誤處理機制

## 注意事項

1. **退水設定**：下級代理的退水比例不能超過上級代理設定的最大值
2. **資金流向**：退水資金來源於會員下注，不會憑空產生
3. **層級限制**：代理只能管理直屬下級，不能跨級管理
4. **即時結算**：退水在每次下注結算時立即分配

## 故障排除

### 常見問題
1. **退水未到帳**：檢查代理鏈設定和系統日誌
2. **層級導航錯誤**：確認代理關係正確設定
3. **餘額不一致**：檢查同步機制和網路連接

### 維護建議
1. 定期檢查交易記錄的一致性
2. 監控退水分配的總金額
3. 備份代理關係和設定數據 